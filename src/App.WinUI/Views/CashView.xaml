<Page
    x:Class="CopyOpsSuite.App.WinUI.Views.CashView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:viewmodels="using:CopyOpsSuite.App.WinUI.ViewModels"
    x:DataType="viewmodels:CashViewModel"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="Background" Value="{ThemeResource SystemControlBackgroundBaseLowBrush}" />
            <Setter Property="BorderBrush" Value="{ThemeResource SystemControlChromeLowBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>
    </Page.Resources>

    <Grid Padding="24" RowSpacing="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Spacing="4">
            <TextBlock Text="Cash Ops" FontSize="32" FontWeight="SemiBold" />
            <TextBlock Text="Monitorea ingresos, ventas y cierres diarios con trasparencia de redondeo y diagnósticos." TextWrapping="Wrap" />
        </StackPanel>

        <muxc:Pivot Grid.Row="1" Margin="0,16,0,0">
            <muxc:PivotItem Header="Hoy">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Resumen por moneda" FontWeight="SemiBold" FontSize="16" />
                        <ScrollViewer HorizontalScrollBarVisibility="Auto">
                            <ItemsRepeater ItemsSource="{x:Bind TodaySummaries}">
                                <ItemsRepeater.Layout>
                                    <muxc:ItemsStackPanel Orientation="Horizontal" Spacing="12" />
                                </ItemsRepeater.Layout>
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate x:DataType="viewmodels:CashCurrencySummary">
                                        <Border Style="{StaticResource CardStyle}" Width="220">
                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{x:Bind Currency}" FontSize="16" FontWeight="SemiBold" />
                                                <TextBlock Text="{x:Bind GbToday, StringFormat='GB hoy: {0:N2}'}" FontSize="12" />
                                                <TextBlock Text="{x:Bind Expected, StringFormat='Esperado: {0:C2}'}" FontSize="12" />
                                                <TextBlock Text="{x:Bind Paid, StringFormat='Cobrado: {0:C2}'}" FontSize="12" />
                                                <TextBlock Text="{x:Bind Difference, StringFormat='Diferencia: {0:C2}'}" FontSize="12" />
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                        </ScrollViewer>
                        <Border Style="{StaticResource CardStyle}">
                            <StackPanel Spacing="6">
                                <TextBlock Text="Último diagnóstico de buffering" FontSize="16" FontWeight="SemiBold" />
                                <TextBlock Text="{x:Bind LastDiagSummaryDisplay}" TextWrapping="WrapWholeWords" FontSize="12" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                                <Button HorizontalAlignment="Right" Click="OnDiagEventsClick" Content="Ver eventos de diagnóstico" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </muxc:PivotItem>

            <muxc:PivotItem Header="Ventas">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                        <muxc:DatePicker Header="Desde" Date="{x:Bind SalesFrom, Mode=TwoWay}" />
                        <muxc:DatePicker Header="Hasta" Date="{x:Bind SalesTo, Mode=TwoWay}" />
                        <ComboBox Header="Estado"
                                  ItemsSource="{x:Bind StatusOptions}"
                                  SelectedValue="{x:Bind SelectedStatus, Mode=TwoWay}"
                                  SelectedValuePath="Value"
                                  DisplayMemberPath="Label"
                                  Width="160" />
                        <muxc:TextBox Header="Operador" Text="{x:Bind OperatorFilter, Mode=TwoWay}" Width="180" />
                        <muxc:TextBox Header="Buscar" Text="{x:Bind SearchText, Mode=TwoWay}" Width="220" />
                        <Button Content="Aplicar" Command="{x:Bind RefreshSalesCommand}" />
                        <Button Content="Limpiar" Command="{x:Bind ResetFiltersCommand}" />
                    </StackPanel>

                    <TextBlock Grid.Row="1"
                               Text="{x:Bind HighlightedSaleMessage}"
                               FontWeight="SemiBold"
                               Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                               TextWrapping="Wrap"
                               Margin="0,4,0,0" />

                    <controls:DataGrid
                        Grid.Row="2"
                        ItemsSource="{x:Bind Sales}"
                        AutoGenerateColumns="False"
                        SelectionMode="Single"
                        CanUserSortColumns="True"
                        HeadersVisibility="All">
                        <controls:DataGrid.Columns>
                            <controls:DataGridTextColumn Header="Hora" Binding="{Binding Timestamp}" Width="140" />
                            <controls:DataGridTextColumn Header="Cliente" Binding="{Binding Customer}" Width="200" />
                            <controls:DataGridTextColumn Header="Operador" Binding="{Binding Operator}" Width="120" />
                            <controls:DataGridTextColumn Header="Moneda" Binding="{Binding Currency}" Width="80" />
                            <controls:DataGridTextColumn Header="Esperado" Binding="{Binding Expected, StringFormat='{}{0:C2}'}" Width="120" />
                            <controls:DataGridTextColumn Header="Cobrado" Binding="{Binding Paid, StringFormat='{}{0:C2}'}" Width="120" />
                            <controls:DataGridTextColumn Header="Estado" Binding="{Binding Status}" Width="100" />
                            <controls:DataGridTextColumn Header="Módulo" Binding="{Binding Method}" Width="120" />
                            <controls:DataGridTextColumn Header="Real GB" Binding="{Binding RealGb}" Width="110" />
                            <controls:DataGridTextColumn Header="Facturable" Binding="{Binding BillableGb}" Width="110" />
                            <controls:DataGridTextColumn Header="Round Mode" Binding="{Binding RoundMode}" Width="120" />
                        </controls:DataGrid.Columns>
                        <controls:DataGrid.RowStyle>
                            <Style TargetType="controls:DataGridRow">
                                <Setter Property="ContextFlyout">
                                    <Setter.Value>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="Abrir job" Click="OnRowOpenJob" />
                                            <MenuFlyoutItem Text="Abrir eventos de job" Click="OnRowOpenAudit" />
                                        </MenuFlyout>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </controls:DataGrid.RowStyle>
                    </controls:DataGrid>
                </Grid>
            </muxc:PivotItem>

            <muxc:PivotItem Header="Cierre">
                <StackPanel Spacing="12">
                    <TextBlock Text="Cierre diario" FontWeight="SemiBold" FontSize="16" />
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <muxc:NumberBox Header="Contado" Value="{x:Bind CountedAmount, Mode=TwoWay}" Minimum="0" Width="160" />
                        <TextBlock Text="{x:Bind ExpectedAmount, StringFormat='Esperado: {0:C2}'}" VerticalAlignment="Bottom" />
                    </StackPanel>
                    <muxc:TextBox Header="Notas" Text="{x:Bind ClosingNotes, Mode=TwoWay}" AcceptsReturn="True" Height="80" />
                    <Button Content="Cerrar caja" Command="{x:Bind CloseShiftCommand}" />
                    <TextBlock Text="{x:Bind ClosingMessage}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                </StackPanel>
            </muxc:PivotItem>
        </muxc:Pivot>
    </Grid>
</Page>
