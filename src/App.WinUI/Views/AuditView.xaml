<Page
    x:Name="RootPage"
    x:Class="CopyOpsSuite.App.WinUI.Views.AuditView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:converters="using:CopyOpsSuite.App.WinUI.Converters"
    xmlns:viewmodels="using:CopyOpsSuite.App.WinUI.ViewModels"
    xmlns:core="using:CopyOpsSuite.Core.Models"
    x:DataType="viewmodels:AuditViewModel"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="Background" Value="{ThemeResource SystemControlBackgroundBaseLowBrush}" />
            <Setter Property="BorderBrush" Value="{ThemeResource SystemControlChromeLowBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:BoolToBrushConverter x:Key="BoolToBrushConverter" />
    </Page.Resources>

    <Grid Padding="24" RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Spacing="4">
            <TextBlock Text="Audit Ops" FontSize="32" FontWeight="SemiBold" />
            <TextBlock Text="Filtros, alertas resueltas y simulaciones basadas en el último diagnóstico." TextWrapping="Wrap" />
            <Border Style="{StaticResource CardStyle}" Margin="0,8,0,0">
                <TextBlock Text="{x:Bind LatestDiagDisplay}" FontSize="12" TextWrapping="Wrap" />
            </Border>
        </StackPanel>

        <muxc:Pivot Grid.Row="1" Margin="0,16,0,0">
            <muxc:PivotItem Header="Eventos">
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <muxc:DatePicker Header="Desde" Date="{x:Bind EventsFrom, Mode=TwoWay}" />
                        <muxc:DatePicker Header="Hasta" Date="{x:Bind EventsTo, Mode=TwoWay}" />
                        <ComboBox Header="Tipo"
                                  ItemsSource="{x:Bind EventTypeOptions}"
                                  SelectedValue="{x:Bind SelectedType, Mode=TwoWay}"
                                  SelectedValuePath="Value"
                                  DisplayMemberPath="Label"
                                  Width="200" />
                        <ComboBox Header="Severidad"
                                  ItemsSource="{x:Bind SeverityOptions}"
                                  SelectedValue="{x:Bind SelectedSeverity, Mode=TwoWay}"
                                  SelectedValuePath="Value"
                                  DisplayMemberPath="Label"
                                  Width="160" />
                        <muxc:TextBox Header="Buscar" Text="{x:Bind SearchText, Mode=TwoWay}" Width="220" />
                        <Button Content="Aplicar" Command="{x:Bind RefreshEventsCommand}" />
                        <Button Content="Reset" Command="{x:Bind ResetEventFiltersCommand}" />
                    </StackPanel>
                    <controls:DataGrid
                        ItemsSource="{x:Bind Events}"
                        AutoGenerateColumns="False"
                        SelectionMode="Single"
                        CanUserSortColumns="True"
                        HeadersVisibility="All">
                        <controls:DataGrid.Columns>
                            <controls:DataGridTextColumn Header="Hora" Binding="{Binding Ts, StringFormat='[{0:yyyy-MM-dd HH:mm:ss}]'}" Width="180" />
                            <controls:DataGridTextColumn Header="Tipo" Binding="{Binding Type}" Width="120" />
                            <controls:DataGridTextColumn Header="Severidad" Binding="{Binding Severity}" Width="110" />
                            <controls:DataGridTextColumn Header="Mensaje" Binding="{Binding Message}" Width="220" />
                            <controls:DataGridTextColumn Header="Job" Binding="{Binding JobId}" Width="180" />
                            <controls:DataGridTextColumn Header="Sale" Binding="{Binding SaleId}" Width="180" />
                        </controls:DataGrid.Columns>
                        <controls:DataGrid.RowStyle>
                            <Style TargetType="controls:DataGridRow">
                                <Setter Property="ContextFlyout">
                                    <Setter.Value>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="Abrir job" Click="OnEventOpenJob" />
                                            <MenuFlyoutItem Text="Abrir sale" Click="OnEventOpenSale" />
                                            <MenuFlyoutItem Text="Copiar detalle" Click="OnEventCopyDetail" />
                                        </MenuFlyout>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </controls:DataGrid.RowStyle>
                    </controls:DataGrid>
                </StackPanel>
            </muxc:PivotItem>

            <muxc:PivotItem Header="Alertas">
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                        <TextBlock Text="Alertas activas" FontWeight="SemiBold" FontSize="16" />
                        <ToggleSwitch Header="Mostrar resueltas" IsOn="{x:Bind ShowResolvedAlerts, Mode=TwoWay}" />
                    </StackPanel>
                    <ItemsRepeater ItemsSource="{x:Bind ActiveAlerts}">
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="core:AlertRecord">
                                <Border Style="{StaticResource CardStyle}">
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="{Binding Severity}" FontWeight="SemiBold" />
                                        <TextBlock Text="{Binding Message}" TextWrapping="Wrap" />
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <Button Content="Abrir job" Click="OnAlertOpenJob" Tag="{Binding JobId}" />
                                            <Button Content="Abrir sale" Click="OnAlertOpenSale" Tag="{Binding JobId}" />
                                            <Button Content="Marcar resuelto" Command="{x:Bind RootPage.ViewModel.ResolveAlertCommand}" CommandParameter="{Binding}" />
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                    <StackPanel Visibility="{x:Bind ShowResolvedAlerts, Converter={StaticResource BoolToVisibilityConverter}}" Spacing="8">
                        <TextBlock Text="Alertas resueltas" FontWeight="SemiBold" FontSize="16" />
                        <ItemsRepeater ItemsSource="{x:Bind ResolvedAlerts}">
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="core:AlertRecord">
                                    <Border Style="{StaticResource CardStyle}" Background="{ThemeResource SystemControlBackgroundBaseLowBrush}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding RaisedAt, StringFormat='Generada: {0:dd/MM HH:mm}'}" FontSize="10" />
                                            <TextBlock Text="{Binding Message}" TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </StackPanel>
                </StackPanel>
            </muxc:PivotItem>

            <muxc:PivotItem Header="Reportes">
                <Grid ColumnSpacing="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*" />
                        <ColumnDefinition Width="3*" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="12">
                        <TextBlock Text="Simulación de transferencia" FontWeight="SemiBold" FontSize="16" />
                        <muxc:TextBox Header="Origen" Text="{x:Bind SimulationSourcePath, Mode=TwoWay}" />
                        <TextBlock Text="Destinos disponibles" FontWeight="SemiBold" />
                        <ListView ItemsSource="{x:Bind SimulationTargets}" SelectionMode="None" MaxHeight="220">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:SimulationDestinationItem">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <CheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}" />
                                        <StackPanel>
                                            <TextBlock Text="{x:Bind DisplayName}" />
                                            <TextBlock Text="{x:Bind BusHint}" FontSize="10" Foreground="{ThemeResource SystemControlForegroundBaseLowBrush}" />
                                        </StackPanel>
                                    </StackPanel>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <Button Content="Ejecutar simulación" Command="{x:Bind RunSimulationCommand}" />
                            <Button Content="Guardar bases" Command="{x:Bind SaveSimulationBaselinesCommand}" />
                        </StackPanel>
                        <TextBlock Text="{x:Bind SimulationStatus}" FontSize="12" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>
                    <StackPanel Grid.Column="1" Spacing="12">
                        <Border Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Text="Resumen" FontWeight="SemiBold" />
                                <TextBlock Text="{x:Bind SimulationSummary}" TextWrapping="WrapWholeWords" />
                            </StackPanel>
                        </Border>
                        <StackPanel>
                            <TextBlock Text="Resultados estimados" FontWeight="SemiBold" />
                            <ListView ItemsSource="{x:Bind SimulationResults}" MaxHeight="300">
                                <ListView.ItemTemplate>
                                    <DataTemplate x:DataType="viewmodels:SimulationResult">
                                        <Border CornerRadius="10" Padding="10" Background="{Binding IsSlowest, Converter={StaticResource BoolToBrushConverter}}">
                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{x:Bind DisplayName}" FontWeight="SemiBold" />
                                                <TextBlock Text="{x:Bind BusHint}" FontSize="10" Foreground="{ThemeResource SystemControlForegroundBaseLowBrush}" />
                                                <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                                                    <TextBlock Text="{x:Bind PlannedDisplay}" />
                                                    <TextBlock Text="{x:Bind BaselineDisplay}" />
                                                    <TextBlock Text="{x:Bind EtaDisplay}" />
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <muxc:NumberBox Header="USB2 (MB/s)" Value="{x:Bind SimulationUsb2Baseline, Mode=TwoWay}" Minimum="1" />
                            <muxc:NumberBox Header="USB3 (MB/s)" Value="{x:Bind SimulationUsb3Baseline, Mode=TwoWay}" Minimum="1" />
                            <muxc:NumberBox Header="Otro (MB/s)" Value="{x:Bind SimulationUnknownBaseline, Mode=TwoWay}" Minimum="1" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </muxc:PivotItem>
        </muxc:Pivot>
    </Grid>
</Page>
