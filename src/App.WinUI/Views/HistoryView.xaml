<Page
    x:Name="HistoryRoot"
    x:Class="CopyOpsSuite.App.WinUI.Views.HistoryView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:converters="using:CopyOpsSuite.App.WinUI.Converters"
    xmlns:viewmodels="using:CopyOpsSuite.App.WinUI.ViewModels"
    x:DataType="viewmodels:HistoryViewModel"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <converters:BoolToBrushConverter x:Key="BoolToBrushConverter" />
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="Background" Value="{ThemeResource SystemControlBackgroundBaseLowBrush}" />
            <Setter Property="BorderBrush" Value="{ThemeResource SystemControlChromeLowBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>
    </Page.Resources>

    <Grid Padding="24" RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Spacing="6">
            <TextBlock Text="Historial de jobs" FontSize="32" FontWeight="SemiBold" />
            <TextBlock Text="Revisa el estado de trabajos previos, bytes procesados y vínculos con la caja y auditoría." TextWrapping="Wrap" />
            <StackPanel Orientation="Horizontal" Spacing="12">
                <Button Content="Refrescar historial" Command="{x:Bind RefreshHistoryCommand}" />
                <TextBlock Text="{x:Bind StatusMessage}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
            </StackPanel>
        </StackPanel>

        <ListView Grid.Row="1"
                  ItemsSource="{x:Bind Jobs}"
                  SelectionMode="None">
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="viewmodels:JobHistoryRow">
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel Spacing="6">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <TextBlock Text="{x:Bind Source}" FontWeight="SemiBold" FontSize="16" />
                                <TextBlock Text="{x:Bind Status}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                                <TextBlock Text="{x:Bind StartedAt}" FontSize="12" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                            </StackPanel>
                            <TextBlock Text="{x:Bind Summary}" FontSize="12" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                            <StackPanel Orientation="Horizontal" Spacing="16">
                                <TextBlock Text="{x:Bind TargetCount, StringFormat='Destinos: {0}'}" FontSize="12" />
                                <TextBlock Text="{x:Bind BytesOk, StringFormat='Bytes OK: {0:N0}'}" FontSize="12" />
                                <TextBlock Text="{x:Bind BytesFailed, StringFormat='Bytes Err: {0:N0}'}" FontSize="12" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <TextBlock Text="{x:Bind ExpectedAmount, StringFormat='Esperado: {0:C2}'}" FontSize="12" />
                                <TextBlock Text="{x:Bind PaidAmount, StringFormat='Pagado: {0:C2}'}" FontSize="12" />
                                <Border Background="{x:Bind HasPaymentGap, Converter={StaticResource BoolToBrushConverter}}" CornerRadius="6" Padding="4,2">
                                    <TextBlock Text="{x:Bind Difference, StringFormat='Diff: {0:C2}'}" FontSize="12" />
                                </Border>
                            </StackPanel>
                            <ItemsRepeater ItemsSource="{x:Bind TargetSnapshots}">
                                <ItemsRepeater.Layout>
                                    <muxc:ItemsWrapGrid Orientation="Horizontal" MaximumRowsOrColumns="1" />
                                </ItemsRepeater.Layout>
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate x:DataType="viewmodels:TargetSnapshotRow">
                                        <Border CornerRadius="8" Padding="6" Margin="0,4,6,0"
                                                Background="{x:Bind HasErrors, Converter={StaticResource BoolToBrushConverter}}">
                                            <StackPanel>
                                                <TextBlock Text="{x:Bind Status}" FontSize="10" />
                                                <TextBlock Text="{x:Bind Summary}" FontSize="10" TextWrapping="WrapWholeWords" />
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{x:Bind Currency}" FontSize="12" />
                                <TextBlock Text="{x:Bind JobId}" FontSize="10" Foreground="{ThemeResource SystemControlForegroundBaseLowBrush}" TextWrapping="Wrap" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </ListView.ItemTemplate>
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="ContextFlyout">
                        <Setter.Value>
                            <MenuFlyout>
                                <MenuFlyoutItem Text="Abrir job" Click="OnHistoryOpenJob" />
                                <MenuFlyoutItem Text="Abrir sale" Click="OnHistoryOpenSale" />
                                <MenuFlyoutItem Text="Ver eventos" Click="OnHistoryOpenEvents" />
                            </MenuFlyout>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>
        </ListView>
    </Grid>
</Page>
